#!/usr/bin/env bash

set -euxo pipefail

TARGET=$1

if [[ "$TARGET" == "staging" ]]; then
    TERRAFORM_ARGS='-auto-approve'
else
    TERRAFORM_ARGS=''
fi

(
    cd infra/$TARGET
    terraform apply $TERRAFORM_ARGS
)

FRONTEND_BUCKET=$(cd infra/$TARGET && terraform output frontendbucket)


aws s3 sync frontend/build s3://$FRONTEND_BUCKET
aws cloudfront create-invalidation --distribution-id `cd infra/$TARGET && terraform output cloudfront` --paths "/index.html"

